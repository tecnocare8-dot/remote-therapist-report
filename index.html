<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Remote Therapist®</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 30px; }
        .tab-menu { display: flex; position: sticky; top: 0; background: #fff; z-index: 1000; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; color: #888; }
        .tab-btn.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
        .container { max-width: 600px; margin: 15px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        label { font-weight: bold; display: block; margin-top: 20px; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .face-img { width: 100%; border-radius: 8px; border: 1px solid #ddd; margin: 15px 0; }
        .load-section { background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #1a73e8; }
        .count-hint { font-size: 13px; color: #1a73e8; font-weight: bold; text-align: right; }
        .count-limit { color: #d93025; }
        #success-message { display: none; text-align: center; padding: 50px 20px; }
    </style>
</head>
<body>

<div class="tab-menu">
    <button class="tab-btn active" onclick="switchTab('input', this)">報告入力</button>
    <button class="tab-btn" onclick="switchTab('face', this)">Face情報</button>
</div>

<div id="tab-input" class="tab-content">
    <div class="container" id="form-container">
        <div class="load-section">
            <div style="display:flex; gap:10px;">
                <input type="email" id="search-email" placeholder="メールで読込/修正" style="margin:0;">
                <button type="button" onclick="loadPrev(this)" style="padding:10px; background:#1a73e8; color:white; border:none; border-radius:8px; width:80px;">読込</button>
            </div>
        </div>
        <form id="mainForm">
            <input type="hidden" name="rowNum" id="rowNum">
            <div id="fields">読み込み中...</div>
            <button type="button" onclick="submitForm(this)" style="background:#1a73e8; color:white; border:none; padding:18px; width:100%; border-radius:8px; font-size:18px; margin-top:30px; font-weight:bold;">送信</button>
        </form>
    </div>
    <div class="container" id="success-message">
        <h2>送信完了</h2>
        <button onclick="location.reload()" style="padding:10px 20px; border-radius:8px; border:1px solid #ccc; background:#fff;">戻る</button>
    </div>
</div>

<div id="tab-face" class="tab-content" style="display:none;">
    <div class="container">
        <h3>Face情報</h3>
        <img id="face-viewer" src="" class="face-img" alt="顔写真">
        <h3 style="margin-top:40px; color:#1a73e8;">参考動画</h3>
        <iframe src="https://www.youtube.com/embed/4_bGkHOccg4" width="100%" height="315" frameborder="0" allowfullscreen style="border-radius:8px;"></iframe>
    </div>
</div>

<script>
    // ★ここをさっきコピーした「新しいデプロイURL(exec)」に書き換えてください★
    const GAS_URL = "https://script.google.com/macros/s/XXXXXXXX/exec";
    let masterData = [];

    // 初期データの読み込み
    window.onload = () => {
        fetch(GAS_URL + "?action=init").then(r => r.json()).then(res => {
            masterData = res.lists;
            if (res.imagesMap && res.imagesMap['ニックネーム']) {
                document.getElementById('face-viewer').src = res.imagesMap['ニックネーム'];
            }
            const fieldsDiv = document.getElementById('fields');
            fieldsDiv.innerHTML = '';
            res.settings.forEach(item => {
                const label = document.createElement('label');
                label.innerText = item.name;
                fieldsDiv.appendChild(label);
                let input = document.createElement(item.type === 'textarea' ? 'textarea' : 'input');
                if (item.type === 'select' || item.type.includes('master_')) {
                    input = document.createElement('select');
                    if (item.type.includes('master_')) {
                        input.className = item.type.replace('master_','') + '-input';
                        input.dataset.group = getGroup(item.name);
                        input.onchange = (e) => updateCascading(e.target);
                    } else {
                        input.add(new Option("-- 選択 --", ""));
                        item.options.forEach(o => input.add(new Option(o, o)));
                    }
                } else {
                    input.type = item.type;
                }
                input.name = item.name;
                if (item.name.includes('計画書へ転記')) {
                    input.classList.add('transcription-target');
                    input.onchange = (e) => validateTranscription(e.target);
                    fieldsDiv.appendChild(input);
                    const hint = document.createElement('div');
                    hint.className = "count-hint";
                    hint.innerText = "0/3 (あと3つ)";
                    fieldsDiv.appendChild(hint);
                } else {
                    fieldsDiv.appendChild(input);
                }
            });
            // 大分類の初期化
            document.querySelectorAll('.major-input').forEach(el => {
                const majors = [...new Set(masterData.map(r => r[0]))];
                el.add(new Option("-- 選択 --", ""));
                majors.forEach(m => el.add(new Option(m, m)));
            });
        });
    };

    function validateTranscription(target) {
        const count = Array.from(document.querySelectorAll('.transcription-target')).filter(el => el.value && el.value !== "" && el.value !== "-- 選択 --").length;
        if (count > 3) { alert("転記できるのは合計3つまでです。"); target.value = ""; }
        document.querySelectorAll('.count-hint').forEach(h => {
            h.innerText = count + "/3 (あと" + (3 - count) + "つ)";
            h.classList.toggle('count-limit', count >= 3);
        });
    }

    function loadPrev(btn) {
        const email = document.getElementById('search-email').value;
        if(!email) return alert("メールを入力してください");
        btn.innerText = "...";
        fetch(GAS_URL + "?action=find&email=" + email).then(r => r.json()).then(res => {
            btn.innerText = "読込";
            if(res.error) return alert("データなし");
            document.getElementById('rowNum').value = res.rowNum;
            const form = document.getElementById('mainForm');
            for (let key in res.data) {
                const el = document.getElementsByName(key)[0];
                if (el) { el.value = res.data[key]; if (el.onchange) el.onchange(); }
            }
            alert("読み込み完了");
        });
    }

    function submitForm(btn) {
        btn.disabled = true;
        btn.innerText = "送信中...";
        const data = Object.fromEntries(new FormData(document.getElementById('mainForm')).entries());
        fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) }).then(() => {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
        });
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).style.display = 'block';
        btn.classList.add('active');
    }

    function getGroup(name) {
        const m = name.match(/(参加|活動|機能)(長期|短期)[１２３]/);
        return m ? m[0] : 'default';
    }

    function updateCascading(target) {
        const group = target.dataset.group;
        const majVal = document.querySelector(`.major-input[data-group="${group}"]`).value;
        const midEl = document.querySelector(`.middle-input[data-group="${group}"]`);
        const minEl = document.querySelector(`.minor-input[data-group="${group}"]`);
        if (target.classList.contains('major-input')) {
            if(midEl) {
                midEl.innerHTML = '<option>-- 選択 --</option>';
                [...new Set(masterData.filter(r => r[0] === majVal).map(r => r[1]))].forEach(x => midEl.add(new Option(x, x)));
            }
        } else if (target.classList.contains('middle-input')) {
            if(minEl) {
                minEl.innerHTML = '<option>-- 選択 --</option>';
                masterData.filter(r => r[0] === majVal && r[1] === target.value).forEach(r => minEl.add(new Option(r[2], r[2])));
            }
        }
    }
</script>
</body>
</html>
