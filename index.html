<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Remote Therapist®</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 30px; }
        .tab-menu { display: flex; position: sticky; top: 0; background: #fff; z-index: 1000; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; color: #888; font-size: 16px; }
        .tab-btn.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
        .container { max-width: 600px; margin: 15px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .field-group { margin-bottom: 35px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        img { width: 100%; border-radius: 8px; margin-bottom: 10px; display: block; border: 1px solid #ddd; background: #f9f9f9; }
        label { font-weight: bold; display: block; font-size: 16px; margin-top: 10px; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .char-hint { color: #d93025; font-size: 13px; font-weight: bold; display: block; text-align: right; margin-top: 4px; }
        .counter { color: #1a73e8; font-weight: bold; text-align: right; margin-top: 8px; }
        .btn-send { width: 100%; padding: 18px; background: #1a73e8; color: white; border:none; border-radius:8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #loading { text-align: center; padding: 50px; font-weight: bold; color: #666; }
    </style>
</head>
<body>
    <div class="tab-menu">
        <button class="tab-btn active" onclick="switchTab('input', this)">報告入力</button>
        <button class="tab-btn" onclick="switchTab('face', this)">Face情報</button>
    </div>

    <div id="tab-input" class="tab-content">
        <div class="container">
            <div id="loading">データを取得中...</div>
            <form id="mainForm" style="display:none;">
                <div id="fields"></div>
                <button type="button" class="btn-send" onclick="sendData()">報告を送信する</button>
            </form>
        </div>
    </div>

    <div id="tab-face" class="tab-content" style="display:none;">
        <div class="container">
            <h3 id="face-title" style="display:none;">Face情報</h3>
            <div id="face-image-area"></div>
            <h3 style="margin-top:40px; color:#1a73e8;">参考動画</h3>
            <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:8px;">
                <iframe src="https://www.youtube.com/embed/4_bGkHOccg4" style="position:absolute; top:0; left:0; width:100%; height:100%;" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <script>
        // 指定いただいたデプロイURL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyVXqSkdzJtwlfWF6Ub5ppaIK4obb7wuCOjsfuIE9lOQfUeAHniuXG7tajMrPJk-jvi/exec";
        let masterData = [];

        window.onload = () => {
            // redirect: follow を強制し、CORSを回避する
            fetch(GAS_URL + "?action=init", { redirect: "follow" })
                .then(r => r.json())
                .then(res => {
                    masterData = res.lists;
                    render(res.config);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainForm').style.display = 'block';
                })
                .catch(err => {
                    document.getElementById('loading').innerText = "通信エラー: GAS側の設定を確認してください。";
                    console.error(err);
                });
        };

        function render(config) {
            const fieldsDiv = document.getElementById('fields');
            const faceArea = document.getElementById('face-image-area');
            fieldsDiv.innerHTML = '';
            
            config.forEach(row => {
                let name = row[0];
                let type = String(row[1]).toLowerCase();
                let options = row[2] ? String(row[2]).split(',') : [];
                let maxLen = row[3];
                let imgUrl = row[4];

                if (!name || name === "項目名") return;

                // Face情報タブ（ニックネーム画像）の処理
                if (name === "ニックネーム") {
                    if (imgUrl) {
                        document.getElementById('face-title').style.display = 'block';
                        const fimg = document.createElement('img');
                        fimg.src = getThumbnailUrl(imgUrl);
                        faceArea.appendChild(fimg);
                    }
                    return;
                }

                const group = document.createElement('div');
                group.className = 'field-group';

                if (imgUrl) {
                    const img = document.createElement('img');
                    img.src = getThumbnailUrl(imgUrl);
                    group.appendChild(img);
                }

                const lbl = document.createElement('label');
                lbl.innerText = name;
                group.appendChild(lbl);

                let input;
                // ICF連動項目の判定
                if (name.includes('__ICF')) {
                    input = document.createElement('select');
                    input.name = name;
                    // グループ名（例：参加長期1）を抽出
                    input.dataset.group = name.split('__')[0].trim();
                    if (name.includes('ICF大')) input.dataset.level = 'major';
                    if (name.includes('ICF中')) input.dataset.level = 'middle';
                    if (name.includes('ICF小')) input.dataset.level = 'minor';
                    input.onchange = (e) => syncICF(e.target);
                } else if (type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 4;
                } else if (type === 'select' || options.length > 0) {
                    input = document.createElement('select');
                    input.add(new Option("-- 選択 --", ""));
                    options.forEach(opt => input.add(new Option(opt.trim(), opt.trim())));
                } else {
                    input = document.createElement('input');
                    input.type = type || 'text';
                }
                
                input.name = name;
                if (maxLen) input.maxLength = maxLen;
                group.appendChild(input);

                if (maxLen && !isNaN(maxLen)) {
                    const hint = document.createElement('span');
                    hint.className = 'char-hint';
                    hint.innerText = "※最大 " + maxLen + " 文字まで";
                    group.appendChild(hint);
                }

                if (name.includes('計画書へ転記')) {
                    input.classList.add('count-target');
                    input.addEventListener('change', updateCount);
                    const counter = document.createElement('div');
                    counter.className = 'counter';
                    counter.innerText = "0 / 3 選択済み";
                    group.appendChild(counter);
                }
                fieldsDiv.appendChild(group);
            });
            initICFMajors();
        }

        // 大項目の初期リスト作成
        function initICFMajors() {
            const majors = [...new Set(masterData.map(r => r[0]))];
            document.querySelectorAll('select[data-level="major"]').forEach(el => {
                el.innerHTML = '<option value="">-- 大項目を選択 --</option>';
                majors.forEach(m => el.add(new Option(m, m)));
            });
        }

        // ICF連動ロジック
        function syncICF(target) {
            const group = target.dataset.group;
            const level = target.dataset.level;
            const majorEl = document.querySelector(`select[data-group="${group}"][data-level="major"]`);
            const middleEl = document.querySelector(`select[data-group="${group}"][data-level="middle"]`);
            const minorEl = document.querySelector(`select[data-group="${group}"][data-level="minor"]`);

            if (level === 'major') {
                middleEl.innerHTML = '<option value="">-- 中項目を選択 --</option>';
                const filtered = [...new Set(masterData.filter(r => r[0] === majorEl.value).map(r => r[1]))];
                filtered.forEach(m => middleEl.add(new Option(m, m)));
                syncICF(middleEl);
            } else if (level === 'middle') {
                minorEl.innerHTML = '<option value="">-- 小項目を選択 --</option>';
                const filtered = masterData.filter(r => r[0] === majorEl.value && r[1] === middleEl.value);
                filtered.forEach(r => minorEl.add(new Option(r[2], r[2])));
            }
        }

        function getThumbnailUrl(rawUrl) {
            let id = "";
            if (rawUrl.includes("/d/")) id = rawUrl.split("/d/")[1].split("/")[0];
            else if (rawUrl.includes("id=")) id = rawUrl.split("id=")[1].split("&")[0];
            return id ? "https://drive.google.com/thumbnail?id=" + id + "&sz=w1000" : "";
        }

        function updateCount() {
            const count = Array.from(document.querySelectorAll('.count-target')).filter(t => t.value !== "").length;
            document.querySelectorAll('.counter').forEach(c => c.innerText = count + " / 3 選択済み");
            if (count > 3) alert("計画書への転記は3つまでにしてください");
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).style.display = 'block';
            btn.classList.add('active');
        }

        function sendData() {
            const btn = document.querySelector('.btn-send');
            btn.disabled = true;
            btn.innerText = "送信中...";
            const formData = Object.fromEntries(new FormData(document.getElementById('mainForm')).entries());
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(formData) }).then(() => {
                alert("送信完了しました");
                location.reload();
            });
        }
    </script>
</body>
</html>
