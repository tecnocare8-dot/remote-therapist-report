<script>
    const GAS_URL = location.href.includes('/exec') ? location.href.split('?')[0] : "https://script.google.com/macros/s/AKfycbzBNSOZVd68XHIvrBkUoOCJF_cHBK5sNUWdo-IGwOIQGrXLcaK8-1C4xKtjAItdzdSM/exec";
    let masterLists = [];
    let functionLists = [];

    window.onload = () => {
        fetch(GAS_URL + "?action=init", { redirect: "follow" })
            .then(r => r.json())
            .then(res => {
                masterLists = res.lists;
                functionLists = res.functionLists;
                render(res.config);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainForm').style.display = 'block';
            }).catch(err => { document.getElementById('loading').innerText = "エラー: GASの設定を確認してください"; });
    };

    function render(config) {
        const fieldsDiv = document.getElementById('fields');
        const faceArea = document.getElementById('face-img-area');
        fieldsDiv.innerHTML = ''; faceArea.innerHTML = '';
        
        config.forEach(row => {
            let name = row[0], type = String(row[1]).trim(), options = row[2] ? String(row[2]).split(',') : [], maxLen = row[3], imgUrl = row[4];
            if (!name || name === "項目名") return;

            // --- 【修正】face型とmovie型の処理 ---
            if (type === 'face' || type === 'movie') {
                const div = document.createElement('div');
                div.style.marginBottom = "20px";
                const lbl = document.createElement('label'); lbl.innerText = name; div.appendChild(lbl);
                
                if (type === 'face' && imgUrl) {
                    const img = document.createElement('img'); img.src = getThumb(imgUrl); div.appendChild(img);
                } else if (type === 'movie' && imgUrl) {
                    const videoId = imgUrl.split('v=')[1] || imgUrl.split('/').pop();
                    div.innerHTML += `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                }
                faceArea.appendChild(div);
                return; // フォーム側には表示しない
            }

            const group = document.createElement('div'); group.className = 'field-group';
            if (imgUrl && name !== "ニックネーム") {
                const img = document.createElement('img'); img.src = getThumb(imgUrl); group.appendChild(img);
            }

            const lbl = document.createElement('label'); lbl.innerText = name; group.appendChild(lbl);

            let input;
            if (type.includes('_major') || type.includes('_middle') || type.includes('_minor')) {
                input = document.createElement('select');
                input.dataset.group = name.split('_')[0].trim();
                input.dataset.source = type.includes('function_') ? 'function' : 'master';
                input.dataset.lv = type.split('_')[1];
                input.onchange = (e) => syncICF(e.target);
            } else if (type === 'textarea') {
                input = document.createElement('textarea'); input.rows = 4;
            } else if (type === 'select' || options.length > 0) {
                input = document.createElement('select'); input.add(new Option("-- 選択 --", ""));
                options.forEach(o => { if(o.trim()) input.add(new Option(o.trim(), o.trim())); });
            } else {
                input = document.createElement('input'); input.type = (type === 'email') ? 'email' : 'text';
            }
            
            input.name = name; if (maxLen && !isNaN(maxLen)) input.maxLength = maxLen;
            group.appendChild(input);

            if (name.includes('計画書へ転記')) {
                input.classList.add('count-target'); input.addEventListener('change', updateCount);
                const cDiv = document.createElement('div'); cDiv.className = 'counter'; cDiv.innerText = "0 / 3 選択済み"; group.appendChild(cDiv);
            }
            fieldsDiv.appendChild(group);
        });
        initICF();
    }

    function initICF() {
        document.querySelectorAll('select[data-lv="major"]').forEach(el => {
            el.innerHTML = '<option value="">-- 選択 --</option>';
            const list = el.dataset.source === 'function' ? functionLists : masterLists;
            const majors = [...new Set(list.map(r => r[0]))].filter(v => v);
            majors.forEach(v => el.add(new Option(v, v)));
        });
    }

    function syncICF(target) {
        const g = target.dataset.group, lv = target.dataset.lv, src = target.dataset.source;
        const list = src === 'function' ? functionLists : masterLists;
        const majorEl = document.querySelector(`select[data-group="${g}"][data-lv="major"]`);
        const middleEl = document.querySelector(`select[data-group="${g}"][data-lv="middle"]`);
        const minorEl = document.querySelector(`select[data-group="${g}"][data-lv="minor"]`);

        if (lv === 'major' && middleEl) {
            middleEl.innerHTML = '<option value="">-- 選択 --</option>';
            const filtered = [...new Set(list.filter(r => r[0] === target.value).map(r => r[1]))].filter(v => v);
            filtered.forEach(v => middleEl.add(new Option(v, v)));
            if(minorEl) { minorEl.innerHTML = '<option value="">-- 選択 --</option>'; }
        } else if (lv === 'middle' && minorEl) {
            minorEl.innerHTML = '<option value="">-- 選択 --</option>';
            list.filter(r => r[0] === majorEl.value && r[1] === target.value).forEach(r => {
                if(r[2]) minorEl.add(new Option(r[2], r[2]));
            });
        }
    }

    // --- 【重要修正】検索データの反映順序を制御 ---
    async function searchData() {
        const email = document.getElementById('search-email').value;
        if (!email) return alert("アドレスを入力");
        
        const res = await fetch(GAS_URL + "?action=find&email=" + encodeURIComponent(email)).then(r => r.json());
        if (res.error === "なし") return alert("過去データなし");
        
        document.getElementById('rowNum').value = res.rowNum;

        // 1. まず通常の項目（textarea等）を埋める
        for (let key in res.data) {
            const els = document.getElementsByName(key);
            if (els.length > 0 && !els[0].dataset.lv) {
                els[0].value = res.data[key];
            }
        }

        // 2. 連動プルダウンを「大→中→小」の順で確定させる
        const levels = ['major', 'middle', 'minor'];
        for (let lv of levels) {
            for (let key in res.data) {
                const els = document.getElementsByName(key);
                if (els.length > 0 && els[0].dataset.lv === lv) {
                    els[0].value = res.data[key];
                    els[0].dispatchEvent(new Event('change')); // 次の階層の選択肢を生成
                }
            }
        }
        
        updateCount(); alert("読込完了");
    }

    function updateCount() {
        const count = Array.from(document.querySelectorAll('.count-target')).filter(t => t.value !== "").length;
        document.querySelectorAll('.counter').forEach(el => el.innerText = count + " / 3 選択済み");
    }

    function getThumb(url) {
        let id = (url.includes("/d/")) ? url.split("/d/")[1].split("/")[0] : (url.includes("id=") ? url.split("id=")[1].split("&")[0] : "");
        return id ? "https://drive.google.com/thumbnail?id=" + id + "&sz=w1000" : "";
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).style.display = 'block'; btn.classList.add('active');
    }

    function sendData() {
        const btn = document.querySelector('.btn-send'); btn.disabled = true; btn.innerText = "送信中...";
        const formData = Object.fromEntries(new FormData(document.getElementById('mainForm')).entries());
        fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(formData) }).then(() => { alert("送信完了"); location.reload(); });
    }
</script>
