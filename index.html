<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Remote Therapist®</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 30px; }
        .tab-menu { display: flex; position: sticky; top: 0; background: #fff; z-index: 1000; border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; color: #888; font-size: 16px; }
        .tab-btn.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
        .container { max-width: 600px; margin: 15px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        label { font-weight: bold; display: block; margin-top: 20px; color: #333; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        
        /* 画像のスタイル：タップできることを示す */
        .face-img { width: 100%; border-radius: 8px; border: 1px solid #ddd; margin: 15px 0; cursor: zoom-in; }
        
        /* 文字数ヒントのスタイル */
        .char-hint { font-size: 12px; color: #d93025; text-align: right; margin-top: 4px; font-weight: bold; }
        
        .load-section { background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #1a73e8; }
        .btn-main { background:#1a73e8; color:white; border:none; padding:18px; width:100%; border-radius:8px; font-size:18px; font-weight:bold; cursor:pointer; margin-top:20px; }
        #success-message { display: none; text-align: center; padding: 50px 20px; }
    </style>
</head>
<body>

<div class="tab-menu">
    <button class="tab-btn active" onclick="switchTab('input', this)">報告入力</button>
    <button class="tab-btn" onclick="switchTab('face', this)">Face情報</button>
</div>

<div id="tab-input" class="tab-content">
    <div class="container" id="form-container">
        <div class="load-section">
            <div style="display:flex; gap:10px;">
                <input type="email" id="search-email" placeholder="メールで読込/修正" style="margin:0;">
                <button type="button" onclick="loadPrev(this)" style="padding:10px; background:#1a73e8; color:white; border:none; border-radius:8px; width:80px;">読込</button>
            </div>
        </div>
        <form id="mainForm">
            <input type="hidden" name="rowNum" id="rowNum">
            <div id="fields">読み込み中...</div>
            <button type="button" class="btn-main" onclick="submitForm(this)">データを送信</button>
        </form>
    </div>
    <div class="container" id="success-message">
        <h2>送信完了</h2>
        <button onclick="location.reload()" class="btn-main" style="background:#888;">戻る</button>
    </div>
</div>

<div id="tab-face" class="tab-content" style="display:none;">
    <div class="container">
        <h3>Face情報</h3>
        <p style="font-size:12px; color:#666;">※画像はピンチアウトで拡大、またはタップで全体表示できます。</p>
        <a id="face-link" target="_blank">
            <img id="face-viewer" src="" class="face-img" alt="顔写真読み込み中">
        </a>
        
        <h3 style="margin-top:40px; color:#1a73e8;">参考動画</h3>
        <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:8px;">
            <iframe src="https://www.youtube.com/embed/4_bGkHOccg4" style="position:absolute; top:0; left:0; width:100%; height:100%;" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
</div>

<script>
    // ★ここを最新のデプロイURL(exec)に書き換えてください★
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxTg_1L82L5NVNglMGUw8SDwnnWTrPkA9aIkXnHQxKfoT2t7_XEAEdaipvmiQw2INf8/exec";
    let masterData = [];

    window.onload = () => {
        fetch(GAS_URL + "?action=init").then(r => r.json()).then(res => {
            masterData = res.lists;
            // 顔写真のセット（リンクも同時にセット）
            if (res.imagesMap && res.imagesMap['ニックネーム']) {
                const imgUrl = res.imagesMap['ニックネーム'];
                document.getElementById('face-viewer').src = imgUrl;
                document.getElementById('face-link').href = imgUrl;
            }
            
            const fieldsDiv = document.getElementById('fields');
            fieldsDiv.innerHTML = '';
            res.settings.forEach(item => {
                const label = document.createElement('label');
                label.innerText = item.name;
                fieldsDiv.appendChild(label);

                let input = document.createElement(item.type === 'textarea' ? 'textarea' : 'input');
                if (item.type === 'select' || item.type.includes('master_')) {
                    input = document.createElement('select');
                    if (item.type.includes('master_')) {
                        input.className = item.type.replace('master_','') + '-input';
                        input.dataset.group = getGroup(item.name);
                        input.onchange = (e) => updateCascading(e.target);
                    } else {
                        input.add(new Option("-- 選択 --", ""));
                        item.options.forEach(o => input.add(new Option(o, o)));
                    }
                } else {
                    input.type = item.type;
                }
                input.name = item.name;
                
                // 【修正】文字数上限がある場合にヒントを表示
                if (item.maxLength) {
                    input.maxLength = item.maxLength;
                }
                
                fieldsDiv.appendChild(input);
                
                // 文字数制限の表示
                if (item.maxLength) {
                    const hint = document.createElement('div');
                    hint.className = "char-hint";
                    hint.innerText = "（上限 " + item.maxLength + " 文字）";
                    fieldsDiv.appendChild(hint);
                }

                // 転記制限ロジック
                if (item.name.includes('計画書へ転記')) {
                    input.classList.add('transcription-target');
                    input.addEventListener('change', (e) => validateTranscription(e.target));
                }
            });
            
            // 大分類の初期化
            document.querySelectorAll('.major-input').forEach(el => {
                const majors = [...new Set(masterData.map(r => r[0]))];
                el.add(new Option("-- 選択 --", ""));
                majors.forEach(m => el.add(new Option(m, m)));
            });
        });
    };

    function validateTranscription(target) {
        const count = Array.from(document.querySelectorAll('.transcription-target')).filter(el => el.value && el.value !== "" && el.value !== "-- 選択 --").length;
        if (count > 3) {
            alert("転記できるのは合計3つまでです。");
            target.value = "";
        }
    }

    function loadPrev(btn) {
        const email = document.getElementById('search-email').value;
        if(!email) return alert("メールを入力してください");
        btn.innerText = "...";
        fetch(GAS_URL + "?action=find&email=" + email).then(r => r.json()).then(res => {
            btn.innerText = "読込";
            if(res.error) return alert("データなし");
            document.getElementById('rowNum').value = res.rowNum;
            const form = document.getElementById('mainForm');
            for (let key in res.data) {
                const el = document.getElementsByName(key)[0];
                if (el) { el.value = res.data[key]; if (el.onchange) el.onchange(); }
            }
            alert("読み込み完了");
        });
    }

    function submitForm(btn) {
        btn.disabled = true;
        btn.innerText = "送信中...";
        const data = Object.fromEntries(new FormData(document.getElementById('mainForm')).entries());
        fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) }).then(() => {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
            window.scrollTo(0, 0);
        });
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).style.display = 'block';
        btn.classList.add('active');
    }

    function getGroup(name) {
        const m = name.match(/(参加|活動|機能)(長期|短期)[１２３]/);
        return m ? m[0] : 'default';
    }

    function updateCascading(target) {
        const group = target.dataset.group;
        const majVal = document.querySelector(`.major-input[data-group="${group}"]`).value;
        const midEl = document.querySelector(`.middle-input[data-group="${group}"]`);
        const minEl = document.querySelector(`.minor-input[data-group="${group}"]`);
        if (target.classList.contains('major-input')) {
            if(midEl) {
                midEl.innerHTML = '<option>-- 選択 --</option>';
                [...new Set(masterData.filter(r => r[0] === majVal).map(r => r[1]))].forEach(x => midEl.add(new Option(x, x)));
            }
        } else if (target.classList.contains('middle-input')) {
            if(minEl) {
                minEl.innerHTML = '<option>-- 選択 --</option>';
                masterData.filter(r => r[0] === majVal && r[1] === target.value).forEach(r => minEl.add(new Option(r[2], r[2])));
            }
        }
    }
</script>
</body>
</html>
