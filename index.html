<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Remote Therapist®</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 30px; }
        .tab-menu { display: flex; position: sticky; top: 0; background: #fff; z-index: 1000; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; color: #888; font-size: 16px; }
        .tab-btn.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
        .container { max-width: 600px; margin: 15px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .field-group { margin-bottom: 35px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        img { width: 100%; border-radius: 8px; margin-bottom: 10px; display: block; border: 1px solid #ddd; }
        label { font-weight: bold; display: block; font-size: 16px; margin-top: 10px; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-send { width: 100%; padding: 18px; background: #1a73e8; color: white; border:none; border-radius:8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .search-area { background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #1a73e8; }
        .char-hint { color: #d93025; font-size: 13px; font-weight: bold; display: block; text-align: right; margin-top: 4px; }
        #loading { text-align: center; padding: 50px; font-weight: bold; color: #666; }
    </style>
</head>
<body>
    <div class="tab-menu">
        <button class="tab-btn active" onclick="switchTab('input', this)">報告入力</button>
        <button class="tab-btn" onclick="switchTab('face', this)">Face情報</button>
    </div>

    <div id="tab-input" class="tab-content">
        <div class="container">
            <div class="search-area">
                <label>前回データ検索（メールアドレス）</label>
                <input type="email" id="search-email" placeholder="example@gmail.com">
                <button type="button" class="btn-send" style="padding:10px; font-size:14px;" onclick="searchData()">検索して自動入力</button>
            </div>
            <div id="loading">読込中...</div>
            <form id="mainForm" style="display:none;">
                <input type="hidden" name="rowNum" id="rowNum">
                <div id="fields"></div>
                <button type="button" class="btn-send" onclick="sendData()">報告を送信する</button>
            </form>
        </div>
    </div>

    <div id="tab-face" class="tab-content" style="display:none;">
        <div class="container">
            <h3>Face情報</h3>
            <div id="face-img-area"></div>
        </div>
    </div>

    <script>
        // ★重要：GitHub時はGASの最新デプロイURLをここに貼り付ける
        const GAS_URL = location.href.includes('/exec') ? location.href.split('?')[0] : "https://script.google.com/macros/s/AKfycbzniQYF5t2dustp8qqkRZHgFoeflmDJkf89E1jCbD1zHqyBQPfRdvQVbXUZVo4_nevX/exec";
        let masterLists = [];

        window.onload = () => {
            fetch(GAS_URL + "?action=init", { redirect: "follow" })
                .then(r => r.json())
                .then(res => {
                    masterLists = res.lists;
                    render(res.config);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainForm').style.display = 'block';
                }).catch(err => { alert("通信エラー: デプロイを確認してください"); });
        };

        function render(config) {
            const fieldsDiv = document.getElementById('fields');
            const faceArea = document.getElementById('face-img-area');
            fieldsDiv.innerHTML = ''; faceArea.innerHTML = '';
            
            config.forEach(row => {
                let name = row[0], type = String(row[1]).trim(), options = row[2] ? String(row[2]).split(',') : [], maxLen = row[3], imgUrl = row[4];
                if (!name || name === "項目名") return;

                // ニックネームをFace情報タブへ
                if (name === "ニックネーム") {
                    if (imgUrl) { const img = document.createElement('img'); img.src = getThumb(imgUrl); faceArea.appendChild(img); }
                    return;
                }

                const group = document.createElement('div'); group.className = 'field-group';
                if (imgUrl) { const img = document.createElement('img'); img.src = getThumb(imgUrl); group.appendChild(img); }

                const lbl = document.createElement('label'); lbl.innerText = name; group.appendChild(lbl);

                let input;
                // ★修正：半角アンダーバー "_ICF" を基準に三段連動を構築
                if (name.includes('_ICF')) {
                    input = document.createElement('select'); input.name = name;
                    input.dataset.group = name.split('_ICF')[0].trim(); // 「参加長期１」など
                    if (name.includes('大')) input.dataset.lv = 'major';
                    else if (name.includes('中')) input.dataset.lv = 'middle';
                    else if (name.includes('小')) input.dataset.lv = 'minor';
                    input.onchange = (e) => syncICF(e.target);
                    input.classList.add('icf-sync');
                } else if (type === 'textarea') {
                    input = document.createElement('textarea'); input.rows = 4;
                } else if (type === 'select' || (type !== 'text' && type !== 'email' && options.length > 0)) {
                    input = document.createElement('select'); input.add(new Option("-- 選択 --", ""));
                    options.forEach(o => { if(o.trim()) input.add(new Option(o.trim(), o.trim())); });
                } else {
                    input = document.createElement('input'); input.type = (type === 'email') ? 'email' : 'text';
                }
                
                input.name = name; 
                if (maxLen && !isNaN(maxLen)) input.maxLength = maxLen;
                group.appendChild(input);

                if (maxLen && !isNaN(maxLen)) {
                    const hint = document.createElement('span'); hint.className = 'char-hint'; hint.innerText = "※最大 " + maxLen + " 文字まで"; group.appendChild(hint);
                }
                fieldsDiv.appendChild(group);
            });
            initICF();
        }

        function initICF() {
            const majors = [...new Set(masterLists.map(r => r[0]))].filter(v => v);
            document.querySelectorAll('select[data-lv="major"]').forEach(el => {
                el.innerHTML = '<option value="">-- 選択 --</option>';
                majors.forEach(v => el.add(new Option(v, v)));
            });
        }

        function syncICF(target) {
            const g = target.dataset.group, lv = target.dataset.lv;
            const majorEl = document.querySelector(`select[data-group="${g}"][data-lv="major"]`);
            const middleEl = document.querySelector(`select[data-group="${g}"][data-lv="middle"]`);
            const minorEl = document.querySelector(`select[data-group="${g}"][data-lv="minor"]`);

            if (lv === 'major' && middleEl) {
                middleEl.innerHTML = '<option value="">-- 選択 --</option>';
                const filtered = [...new Set(masterLists.filter(r => r[0] === majorEl.value).map(r => r[1]))].filter(v => v);
                filtered.forEach(v => middleEl.add(new Option(v, v)));
                if(minorEl) {
                    minorEl.innerHTML = '<option value="">-- 選択 --</option>';
                    syncICF(middleEl); // 連鎖的にリセット
                }
            } else if (lv === 'middle' && minorEl) {
                minorEl.innerHTML = '<option value="">-- 選択 --</option>';
                masterLists.filter(r => r[0] === majorEl.value && r[1] === target.value).forEach(r => {
                    if(r[2]) minorEl.add(new Option(r[2], r[2]));
                });
            }
        }

        function searchData() {
            const email = document.getElementById('search-email').value;
            if (!email) return alert("アドレスを入力してください");
            fetch(GAS_URL + "?action=find&email=" + encodeURIComponent(email), { redirect: "follow" })
                .then(r => r.json()).then(res => {
                    if (res.error === "なし") return alert("過去データなし");
                    document.getElementById('rowNum').value = res.rowNum;
                    for (let key in res.data) {
                        const els = document.getElementsByName(key);
                        if (els.length > 0) { 
                            els[0].value = res.data[key]; 
                            if (els[0].tagName === 'SELECT') els[0].dispatchEvent(new Event('change')); 
                        }
                    }
                    alert("読込完了");
                });
        }

        function getThumb(url) {
            let id = url.includes("/d/") ? url.split("/d/")[1].split("/")[0] : (url.includes("id=") ? url.split("id=")[1].split("&")[0] : "");
            return id ? "https://drive.google.com/thumbnail?id=" + id + "&sz=w1000" : "";
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).style.display = 'block'; btn.classList.add('active');
        }

        function sendData() {
            const btn = document.querySelector('.btn-send'); btn.disabled = true; btn.innerText = "送信中...";
            const formData = Object.fromEntries(new FormData(document.getElementById('mainForm')).entries());
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(formData) }).then(() => {
                alert("送信完了"); location.reload();
            });
        }
    </script>
</body>
</html>
