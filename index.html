<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Therapist® Report System</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 30px; }
        .tab-menu { display: flex; position: sticky; top: 0; background: #fff; z-index: 1000; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; color: #888; font-size: 16px; }
        .tab-btn.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
        .container { max-width: 600px; margin: 15px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .field-group { margin-bottom: 35px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        img { width: 100%; border-radius: 8px; margin-bottom: 10px; display: block; border: 1px solid #ddd; }
        label { font-weight: bold; display: block; font-size: 16px; margin-top: 10px; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-send { width: 100%; padding: 18px; background: #1a73e8; color: white; border:none; border-radius:8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .search-area { background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #1a73e8; }
        .counter { color: #1a73e8; font-weight: bold; text-align: right; margin-top: 8px; font-size: 14px; }
        #loading { text-align: center; padding: 50px; font-weight: bold; color: #666; }
        .limit-text { color: red; font-size: 12px; font-weight: normal; margin-left: 5px; }
        #pdf-viewer { width: 100%; height: 500px; border: 1px solid #ccc; margin-bottom: 20px; display: none; border-radius: 8px; }
        .report-status { color: red; font-weight: bold; margin-left: 10px; display: none; font-size: 14px; }
        .save-info { font-size: 12px; color: #28a745; text-align: center; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="tab-menu">
        <button class="tab-btn active" onclick="switchTab('input', this)">報告入力</button>
        <button class="tab-btn" onclick="switchTab('face', this)">Face情報</button>
    </div>

    <div id="tab-input" class="tab-content">
        <div class="container">
            <div class="search-area">
                <label>前回データ検索（メールアドレス）</label>
                <input type="email" id="search-email" placeholder="example@gmail.com">
                <button type="button" class="btn-send" style="padding:10px; font-size:14px;" onclick="searchData()">検索して自動入力</button>
            </div>
            <div id="loading">接続中...</div>
            <form id="mainForm" style="display:none;">
                <input type="hidden" name="rowNum" id="rowNum">
                <div id="fields"></div>
                <div id="save-status" class="save-info">✔ 入力内容を一時保存しました</div>
                <button type="button" class="btn-send" onclick="sendData()">報告を送信する</button>
            </form>
        </div>
    </div>

    <div id="tab-face" class="tab-content" style="display:none;">
        <div class="container">
            <h3>Face情報 <span id="report-flag" class="report-status">(最新レポートあり)</span></h3>
            <iframe id="pdf-viewer"></iframe>
            <div id="face-img-area"></div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxXdacpiLbTl2HODDQYN2msNZfSLUGi2xjBKKjIJlhxraSa5eANJohmxAmAVHXJOHk-/exec"; 

        let masterLists = [], functionLists = [], activityLists = [], currentConfig = [];
        const STORAGE_KEY = "rt_report_temp";

        function callGAS(params, callback) {
            const id = 'jsonp_' + Date.now();
            window[id] = (data) => {
                callback(data);
                const el = document.getElementById(id);
                if (el) document.body.removeChild(el);
                delete window[id];
            };
            const script = document.createElement('script');
            script.id = id;
            const query = Object.keys(params).map(k => k + '=' + encodeURIComponent(params[k])).join('&');
            script.src = GAS_URL + (GAS_URL.indexOf('?') > -1 ? '&' : '?') + query + '&callback=' + id;
            document.body.appendChild(script);
        }

        window.onload = () => {
            callGAS({ action: 'init' }, (data) => {
                masterLists = data.lists || [];
                functionLists = data.functionLists || [];
                activityLists = data.activityLists || [];
                currentConfig = data.config;
                render(data.config);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainForm').style.display = 'block';
                
                // 初回ロード後に一時保存データを復元
                loadFromStorage();
            });
        };

        function render(config, overrideData = null) {
            const fieldsDiv = document.getElementById('fields');
            const faceArea = document.getElementById('face-img-area');
            fieldsDiv.innerHTML = ''; faceArea.innerHTML = '';
            
            config.forEach(row => {
                let name = row[0], type = String(row[1]).trim().toLowerCase(), options = row[2] ? String(row[2]).split(',') : [], maxLen = row[3];
                let imgUrl = (overrideData && overrideData[name]) ? overrideData[name] : row[4];

                if (!name || name === "項目名" || name === "PDFリンク") return;

                // --- 画像・動画項目の特殊処理（hidden追加） ---
                if (type === 'face' || type === 'movie' || (name === "ニックネーム" && imgUrl)) {
                    const g = document.createElement('div'); g.style.marginBottom = "25px";
                    g.innerHTML = `<label style="color:#1a73e8;">${name}</label>`;

                    // GASにURLを送るための隠しフィールド
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = name;
                    hiddenInput.value = imgUrl || ""; 
                    g.appendChild(hiddenInput);

                    if (type === 'movie' && imgUrl) {
                        const vId = imgUrl.split('v=')[1] || imgUrl.split('/').pop().split('?')[0];
                        g.innerHTML += `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${vId}" frameborder="0" allowfullscreen></iframe>`;
                    } else if (imgUrl) {
                        const img = document.createElement('img'); img.src = getThumb(imgUrl); g.appendChild(img);
                    }
                    faceArea.appendChild(g);
                    if (type === 'face' || type === 'movie') return;
                }

                const group = document.createElement('div'); group.className = 'field-group';
                if (imgUrl && name !== "ニックネーム") {
                    const img = document.createElement('img'); img.src = getThumb(imgUrl); group.appendChild(img);
                }

                const lbl = document.createElement('label'); lbl.innerText = name;
                if (maxLen && !isNaN(maxLen)) {
                    const span = document.createElement('span'); span.className = 'limit-text';
                    span.innerText = ` (最大 ${maxLen} 文字)`; lbl.appendChild(span);
                }
                group.appendChild(lbl);

                let input;
                if (type.includes('_major') || type.includes('_middle') || type.includes('_minor')) {
                    input = document.createElement('select');
                    input.dataset.group = name.split('_')[0].trim();
                    input.dataset.source = type.includes('function_') ? 'function' : (type.includes('activity_') ? 'activity' : 'master');
                    input.dataset.lv = type.split('_')[1];
                    input.onchange = (e) => { syncICF(e.target); saveToStorage(); };
                } else if (type === 'textarea') {
                    input = document.createElement('textarea'); input.rows = 4;
                    input.oninput = saveToStorage;
                } else if (type === 'select' || options.length > 0) {
                    input = document.createElement('select'); input.add(new Option("-- 選択 --", ""));
                    options.forEach(o => { if(o.trim()) input.add(new Option(o.trim(), o.trim())); });
                    input.onchange = saveToStorage;
                } else {
                    input = document.createElement('input'); input.type = (type === 'email') ? 'email' : 'text';
                    input.oninput = saveToStorage;
                }
                
                input.name = name;
                if (maxLen && !isNaN(maxLen)) input.maxLength = maxLen;
                group.appendChild(input);

                if (name.includes('計画書へ転記')) {
                    input.classList.add('count-target'); 
                    input.addEventListener('change', updateCount);
                }
                fieldsDiv.appendChild(group);
            });
            initICF();
        }

        // --- ICF階層連動ロジック ---
        function getListBySource(src) {
            return src === 'function' ? functionLists : (src === 'activity' ? activityLists : masterLists);
        }

        function initICF() {
            document.querySelectorAll('select[data-lv="major"]').forEach(el => {
                el.innerHTML = '<option value="">-- 選択 --</option>';
                const list = getListBySource(el.dataset.source);
                [...new Set(list.map(r => r[0]))].filter(v => v).forEach(v => el.add(new Option(v, v)));
            });
        }

        function syncICF(target) {
            const g = target.dataset.group, lv = target.dataset.lv, src = target.dataset.source;
            const list = getListBySource(src);
            const majorEl = document.querySelector(`select[data-group="${g}"][data-lv="major"]`);
            const middleEl = document.querySelector(`select[data-group="${g}"][data-lv="middle"]`);
            const minorEl = document.querySelector(`select[data-group="${g}"][data-lv="minor"]`);

            if (lv === 'major' && middleEl) {
                middleEl.innerHTML = '<option value="">-- 選択 --</option>';
                [...new Set(list.filter(r => r[0] === target.value).map(r => r[1]))].filter(v => v).forEach(v => middleEl.add(new Option(v, v)));
                if(minorEl) minorEl.innerHTML = '<option value="">-- 選択 --</option>';
            } else if (lv === 'middle' && minorEl) {
                minorEl.innerHTML = '<option value="">-- 選択 --</option>';
                list.filter(r => r[0] === majorEl.value && r[1] === target.value).forEach(r => { if(r[2]) minorEl.add(new Option(r[2], r[2])); });
            }
        }

        // --- データの検索と呼び出し ---
        function searchData() {
            const email = document.getElementById('search-email').value;
            if (!email) return alert("アドレスを入力してください");
            
            callGAS({ action: 'find', email: email }, (res) => {
                if (!res.data) return alert("過去データが見つかりませんでした");
                
                document.getElementById('rowNum').value = res.rowNum;
                const data = res.data;

                // 入力欄にセット
                document.querySelectorAll('#mainForm input, #mainForm textarea, #mainForm select').forEach(el => {
                    if (data[el.name] !== undefined) {
                        el.value = data[el.name];
                        if (el.dataset.lv === "major" || el.dataset.lv === "middle") syncICF(el);
                    }
                });

                // PDFリンクをFaceタブにセット
                const pdfViewer = document.getElementById('pdf-viewer');
                const reportFlag = document.getElementById('report-flag');
                const pdfUrl = data["PDFリンク"];
                if (pdfUrl) {
                    const previewUrl = pdfUrl.replace("/view?usp=drivesdk", "/preview").replace("/view", "/preview");
                    pdfViewer.src = previewUrl;
                    pdfViewer.style.display = 'block';
                    reportFlag.style.display = 'inline';
                }

                updateCount();
                saveToStorage(); // 検索結果も一時保存対象にする
                alert("過去データを読み込みました。Faceタブでレポートを確認できます。");
            });
        }

        // --- 一時保存（Local Storage）機能 ---
        function saveToStorage() {
            const formData = {};
            document.querySelectorAll('#mainForm [name]').forEach(el => {
                formData[el.name] = el.value;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
            
            const status = document.getElementById('save-status');
            status.style.display = 'block';
            setTimeout(() => { status.style.display = 'none'; }, 2000);
        }

        function loadFromStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            const data = JSON.parse(saved);
            
            document.querySelectorAll('#mainForm input, #mainForm textarea, #mainForm select').forEach(el => {
                if (data[el.name] !== undefined) {
                    el.value = data[el.name];
                    if (el.dataset.lv === "major" || el.dataset.lv === "middle") syncICF(el);
                }
            });
            updateCount();
        }

        function updateCount() {
            const count = Array.from(document.querySelectorAll('.count-target')).filter(t => t.value === "転記する").length;
            document.querySelectorAll('.counter').forEach(el => el.innerText = count + " / 3 選択済み");
        }

        function getThumb(url) {
            if(!url) return "";
            let id = (url.includes("/d/")) ? url.split("/d/")[1].split("/")[0] : (url.includes("id=") ? url.split("id=")[1].split("&")[0] : "");
            return id ? "https://drive.google.com/thumbnail?id=" + id + "&sz=w1000" : "";
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).style.display = 'block'; btn.classList.add('active');
        }

        function sendData() {
            const btn = document.querySelector('.btn-send');
            btn.disabled = true; btn.innerText = "データ送信・PDF作成中...";

            const payload = {};
            document.querySelectorAll('#mainForm [name]').forEach(el => { payload[el.name] = el.value; });
            
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) })
            .then(() => {
                localStorage.removeItem(STORAGE_KEY); // 送信成功時のみ一時保存を消去
                document.getElementById('fields').innerHTML = `
                    <div style="text-align:center; padding:40px; color:#1a73e8; font-weight:bold;">
                        <p>送信完了しました！</p>
                        <p>現在バックエンドでV${Number(payload.rowNum ? 2 : 1)}レポートを作成中です。</p>
                        <p>数秒後に自動でリロードします。</p>
                    </div>`;
                setTimeout(() => { location.reload(); }, 4000);
            });
        }
    </script>
</body>
</html>
