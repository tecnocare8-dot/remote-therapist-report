<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Remote Therapist®</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 30px; }
        .tab-menu { display: flex; position: sticky; top: 0; background: #fff; z-index: 1000; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; color: #888; font-size: 16px; }
        .tab-btn.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
        .container { max-width: 600px; margin: 15px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .field-group { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        img { width: 100%; border-radius: 8px; margin-bottom: 10px; display: block; border: 1px solid #ddd; background: #f9f9f9; }
        label { font-weight: bold; display: block; font-size: 16px; margin-top: 10px; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .char-hint { color: #d93025; font-size: 13px; font-weight: bold; display: block; text-align: right; margin-top: 4px; }
        .counter { color: #1a73e8; font-weight: bold; text-align: right; margin-top: 8px; }
        .btn-send { width: 100%; padding: 18px; background: #1a73e8; color: white; border:none; border-radius:8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #loading { text-align: center; padding: 50px; font-weight: bold; color: #666; }
    </style>
</head>
<body>
    <div class="tab-menu">
        <button class="tab-btn active" onclick="switchTab('input', this)">報告入力</button>
        <button class="tab-btn" onclick="switchTab('face', this)">Face情報</button>
    </div>

    <div id="tab-input" class="tab-content">
        <div class="container">
            <div id="loading">データを読込中...</div>
            <form id="mainForm" style="display:none;">
                <div id="fields"></div>
                <button type="button" class="btn-send" onclick="sendData()">報告を送信する</button>
            </form>
        </div>
    </div>

    <div id="tab-face" class="tab-content" style="display:none;">
        <div class="container">
            <h3>Face情報</h3>
            <img id="face-viewer" src="" style="width:100%; border-radius:8px; display:none;">
            <h3 style="margin-top:40px; color:#1a73e8;">参考動画</h3>
            <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:8px;">
                <iframe src="https://www.youtube.com/embed/4_bGkHOccg4" style="position:absolute; top:0; left:0; width:100%; height:100%;" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <script>
        // ★ここにGASの最新デプロイURL(/exec)を貼り付けてください★
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzNStpU7fS2-anLqBGNLKQ6uHxD_Frf-a579lxZpYXgIc5qoPyq1Jfc799Tpoiww1AA/exec";

        window.onload = () => {
            fetch(GAS_URL + "?action=init")
                .then(res => res.json())
                .then(res => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainForm').style.display = 'block';
                    render(res);
                })
                .catch(err => {
                    document.getElementById('loading').innerText = "通信エラー: デプロイ設定が「全員」になっているか確認してください。";
                });
        };

        function render(res) {
            const fieldsDiv = document.getElementById('fields');
            fieldsDiv.innerHTML = '';
            
            // Face画像
            if (res.imagesMap && res.imagesMap['ニックネーム']) {
                const faceImg = document.getElementById('face-viewer');
                faceImg.src = res.imagesMap['ニックネーム'];
                faceImg.style.display = 'block';
            }

            res.settings.forEach(item => {
                if (!item.name || item.name === "項目名" || item.name === "ニックネーム") return;

                const group = document.createElement('div');
                group.className = 'field-group';

                // 図の表示
                if (res.imagesMap && res.imagesMap[item.name]) {
                    const img = document.createElement('img');
                    img.src = res.imagesMap[item.name];
                    group.appendChild(img);
                }

                const lbl = document.createElement('label');
                lbl.innerText = item.name;
                group.appendChild(lbl);

                let input;
                if (item.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 4;
                } else if (item.type === 'select' || (item.options && item.options.length > 0)) {
                    input = document.createElement('select');
                    input.add(new Option("-- 選択 --", ""));
                    item.options.forEach(opt => input.add(new Option(opt, opt)));
                } else {
                    input = document.createElement('input');
                    input.type = item.type || 'text';
                }
                
                input.name = item.name;
                if (item.maxLength) input.maxLength = item.maxLength;
                group.appendChild(input);

                // 上限文字数の表示
                if (item.maxLength) {
                    const hint = document.createElement('span');
                    hint.className = 'char-hint';
                    hint.innerText = "※最大 " + item.maxLength + " 文字まで";
                    group.appendChild(hint);
                }

                // カウンター
                if (item.name.includes('計画書へ転記')) {
                    input.classList.add('count-target');
                    input.addEventListener('change', updateCount);
                    const counter = document.createElement('div');
                    counter.className = 'counter';
                    counter.innerText = "0 / 3 選択済み";
                    group.appendChild(counter);
                }
                fieldsDiv.appendChild(group);
            });
        }

        function updateCount() {
            const count = Array.from(document.querySelectorAll('.count-target')).filter(t => t.value !== "").length;
            document.querySelectorAll('.counter').forEach(c => c.innerText = count + " / 3 選択済み");
            if (count > 3) alert("3つまでにしてください");
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).style.display = 'block';
            btn.classList.add('active');
        }

        function sendData() {
            const btn = document.querySelector('.btn-send');
            btn.disabled = true;
            btn.innerText = "送信中...";
            const formData = Object.fromEntries(new FormData(document.getElementById('mainForm')).entries());
            
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(formData)
            }).then(() => {
                alert("報告を送信しました");
                location.reload();
            });
        }
    </script>
</body>
</html>
